---
alwaysApply: true
---

# Data Validation Rules for Analysis

## Core Principle

Before presenting any analysis result, validate the data like a careful analyst would. 
**Always explain what you're checking and flag any issues found.**

---

## Conversational Mode Integration

When conversational mode is active (default), validation summaries will be presented at checkpoints for user review before proceeding.

See `conversational_workflow.mdc` for checkpoint details and timing.

---

## How to Report Checks

For every validation, use this format:

```
âœ“ CHECK: [Test Name]
  What: [Brief description of what's being tested]
  Result: [PASS / âš ï¸ WARNING / ðŸš¨ FAIL]
  Details: [Numbers or explanation]
```

---

## 1. Join Validation

Run these checks **every time you join tables**:

### 1.1 Row Count Impact
```sql
-- Before join: COUNT(*) from left table
-- After join: COUNT(*) from result
-- Flag if: increase >5% (fan-out) or decrease >5% (unexpected drop)
```

### 1.2 Orphan Records
```sql
-- Count records from LEFT JOIN where right side is NULL
-- Flag if: >10% orphans (unless expected)
```

### 1.3 Duplicate Keys
```sql
-- Check join keys for duplicates before joining
-- Flag if: duplicates exist on "one" side of a 1:many join
```

**Report Example:**
```
âœ“ CHECK: Join Validation (users â†’ orders)
  What: Verifying join doesn't cause fan-out or data loss
  Result: âš ï¸ WARNING
  Details: 
    - Before: 10,000 rows â†’ After: 10,847 rows (+8.5% fan-out)
    - 234 users have no orders (2.3% orphans)
    - Cause: 847 users have multiple orders (expected for this analysis)
```

---

## 2. Aggregation Sanity

Run these checks **after any GROUP BY or summary**:

### 2.1 Percentage Sum
```sql
-- SUM of percentage column should equal ~100%
-- Flag if: deviation >1%
```

### 2.2 Segment Totals Match Source
```sql
-- SUM of segment counts should equal total source records
-- Flag if: any mismatch
```

### 2.3 Logical Value Ranges
```sql
-- Counts, revenue, quantities should be >= 0
-- Rates/percentages should be 0-100%
-- Flag if: impossible values found
```

### 2.4 Concentration Check
```sql
-- No single segment should be >90% unless explicitly expected
-- Flag if: extreme concentration detected
```

**Report Example:**
```
âœ“ CHECK: Aggregation Sanity (revenue by region)
  What: Verifying grouped totals are logically consistent
  Result: PASS
  Details:
    - Percentages sum to 100.0%
    - Segment total (1,247,832) matches source count
    - All revenue values >= 0
    - Largest segment is 34% (North America)
```

---

## 3. Segment/Cohort Validation

Run these checks **when creating user segments or cohorts**:

### 3.1 Mutual Exclusivity
```sql
-- Each entity should appear in exactly one segment (if intended)
-- Count entities appearing in multiple segments
-- Flag if: any overlaps found when segments should be exclusive
```

### 3.2 Complete Coverage
```sql
-- All source entities should be classified
-- Flag if: unclassified entities >0 (unless "Other" bucket exists)
```

### 3.3 NULL/Unknown Bucket Size
```sql
-- Track size of NULL, Unknown, or Other segments
-- Flag if: >20% of data falls into catch-all bucket
```

### 3.4 Segment Size Reasonability
```sql
-- Each segment should have meaningful size for analysis
-- Flag if: any segment has <30 records (statistical significance concern)
```

**Report Example:**
```
âœ“ CHECK: Segment Validation (customer_tier)
  What: Verifying segments are mutually exclusive and complete
  Result: ðŸš¨ FAIL
  Details:
    - 142 customers appear in multiple tiers (overlap detected!)
    - 99.2% coverage (87 customers unclassified)
    - "Unknown" bucket: 4.2% (acceptable)
    - Smallest segment: "Enterprise" with 89 records (OK)
  Action Required: Investigate 142 overlapping customers before proceeding
```

---

## 4. Time-Series Validation

Run these checks **when analyzing data over time**:

### 4.1 Date Continuity
```sql
-- Check for gaps in date sequence
-- Flag if: missing dates/periods in the range
```

### 4.2 No Future Dates
```sql
-- All dates should be <= current date (or expected max date)
-- Flag if: future dates found
```

### 4.3 Volatility Check
```sql
-- Calculate period-over-period change
-- Flag if: >50% change without known explanation
```

### 4.4 Consistent Granularity
```sql
-- All periods should have similar record counts (adjusting for known patterns)
-- Flag if: any period has <50% of average count
```

**Report Example:**
```
âœ“ CHECK: Time-Series Validation (daily_signups, last 30 days)
  What: Verifying date continuity and reasonable patterns
  Result: âš ï¸ WARNING
  Details:
    - Date range: 2024-11-16 to 2024-12-15 (complete, no gaps)
    - No future dates
    - Dec 3: -62% drop vs previous day (investigate!)
    - All other days within normal range (Â±25%)
```

---

## 5. Final Output Validation

Run these checks **before delivering results**:

### 5.1 Business Question Alignment
```
-- Does the output actually answer the original question?
-- Flag if: key metrics or dimensions are missing
```

### 5.2 Column Clarity
```
-- All columns should have clear, business-friendly names
-- No raw IDs or technical names in final output
-- Flag if: ambiguous column names exist
```

### 5.3 No Sensitive Data Exposure
```
-- Check for PII: emails, phone numbers, full names, addresses
-- Check for internal IDs that shouldn't be shared
-- Flag if: any sensitive data in output
```

### 5.4 Edge Cases Documented
```
-- Note any filters, exclusions, or special handling
-- Flag if: significant exclusions not documented
```

**Report Example:**
```
âœ“ CHECK: Final Output Validation
  What: Ensuring output is complete, clear, and safe to share
  Result: PASS
  Details:
    - Answers question: "What is churn rate by customer segment?" âœ“
    - All columns named clearly (no raw IDs)
    - No PII detected
    - Documented: Excludes trial accounts (12% of base)
```

---

## Validation Summary Template

After all checks, provide a summary:

```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ“‹ DATA VALIDATION SUMMARY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Analysis: [Name]
Date: [YYYY-MM-DD]

Checks Performed: X
â”œâ”€â”€ Passed: X
â”œâ”€â”€ Warnings: X  
â””â”€â”€ Failed: X

âš ï¸ WARNINGS:
  1. [Brief description + location]

ðŸš¨ FAILURES (action required):
  1. [Brief description + recommended action]

Overall Status: [READY FOR USE / REVIEW WARNINGS / BLOCKED BY FAILURES]
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

---

## Quick Reference: When to Run What

| Action | Validations to Run |
|--------|-------------------|
| JOIN tables | 1.1, 1.2, 1.3 |
| GROUP BY / aggregate | 2.1, 2.2, 2.3, 2.4 |
| Create segments | 3.1, 3.2, 3.3, 3.4 |
| Analyze trends | 4.1, 4.2, 4.3, 4.4 |
| Deliver results | 5.1, 5.2, 5.3, 5.4 |

---

## Agent Behavior Rules

1. **Announce** each check before running it
2. **Show** the actual numbers, not just pass/fail
3. **Explain** why a warning or failure matters
4. **Pause** on failures and ask user how to proceed
5. **Summarize** all validations at the end of analysis